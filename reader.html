<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live by Quran – Preview</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html,body { height:100%; overflow-x:hidden; }
    body {
      font-family:Arial,sans-serif;
      color:#fff;
      background:#000;
    }
    header {
      position:fixed; top:0; left:0; right:0;
      background:rgba(0,0,0,0.6);
      display:flex; align-items:center; gap:10px;
      padding:10px 20px; z-index:10;
    }
    header img { height:36px; }
    header h1 {
      font-size:1.2rem; font-weight:400;
    }
    .parallax {
      position:relative; height:80vh;
      background-attachment:fixed;
      background-position:center;
      background-size:cover;
    }
    .overlay {
      position:absolute; inset:0;
      background:rgba(0,0,0,0.3);
    }
    .text-block {
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      max-width:600px; padding:20px;
      background:rgba(0,0,0,0.5);
      border-radius:6px;
      line-height:1.5;
    }
    .text-block h2 {
      font-size:1.6rem; margin-bottom:.5em;
      border-bottom:1px solid #fff; padding-bottom:.3em;
    }
    main { margin-top:56px; } /* header height */
  </style>
</head>
<body>

  <header id="book-header">
    <img id="book-cover" src="" alt="cover" />
    <h1 id="book-title">Loading…</h1>
  </header>

  <main id="reader">
    <!-- JS will inject: 
         1) Preface section 
         2) One .parallax per chapter image -->
  </main>

  <script>
    // parse query string ?slug=...
    const params = new URLSearchParams(location.search);
    const slug = params.get('slug');
    if(!slug){
      document.body.innerHTML = '<p style="padding:20px;color:red;">No book specified.</p>';
      throw '';
    }

    // helper: load text from file
    async function loadText(path){
      const r = await fetch(path);
      if(!r.ok) throw new Error('not found');
      return r.text();
    }

    // 1) Load metadata from books.csv
    async function loadCSV(){
      const txt = await loadText('assets/books/books.csv');
      const [head, ...rows] = txt.trim().split('\n');
      const cols = head.split(',');
      for(let r of rows){
        const vals = r.split(',');
        if(vals[0]===slug){
          let obj = {};
          cols.forEach((c,i)=>obj[c]=vals[i]);
          return obj;
        }
      }
      throw new Error('book not in CSV');
    }

    // 2) Render header & preface
    async function init(){
      try{
        const book = await loadCSV();
        document.getElementById('book-title').textContent = book.title;
        document.getElementById('book-cover').src =
          `assets/books/${slug}/${book.cover}`;

        // preface.txt 
        const preface = await loadText(`assets/books/${slug}/preface.txt`);
        const preSec = document.createElement('section');
        preSec.className = 'parallax';
        preSec.style.backgroundImage = `url('assets/books/${slug}/chapters/bg.jpg')`;
        preSec.innerHTML = `
          <div class="overlay"></div>
          <div class="text-block">
            <h2>Preface</h2>
            <div>${preface.replace(/\n/g,'<br>')}</div>
          </div>`;
        document.getElementById('reader').appendChild(preSec);

        // chapter images list (manually enumerated here)
        const chapters = [
          'chapter1.jpg',
          'chapter2.jpg',
          'chapter3.jpg',
          'chapter4.jpg'
        ];
        chapters.forEach(fn=>{
          const sec = document.createElement('section');
          sec.className = 'parallax';
          sec.style.backgroundImage =
            `url('assets/books/${slug}/chapters/${fn}')`;
          document.getElementById('reader').appendChild(sec);
        });

      }catch(err){
        console.error(err);
        document.getElementById('reader').innerHTML =
          '<p style="padding:20px;color:red;">Failed to load preview.</p>';
      }
    }
    init();
  </script>

</body>
</html>
